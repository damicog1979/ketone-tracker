<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ketone + Food Tracker</title>

  <!-- iPhone app-like -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#111111">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./icon.svg">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7f8; color:#111; }
    header { padding: 16px 14px; background:#fff; position: sticky; top:0; border-bottom:1px solid #e6e6e6; z-index:10; }
    h1 { font-size:18px; margin:0 0 8px; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    button.tab { border:1px solid #d7d7d7; background:#fff; padding:8px 10px; border-radius:10px; font-size:14px; cursor:pointer; }
    button.tab.active { border-color:#111; }
    main { padding:14px; max-width:900px; margin:0 auto; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:12px; margin-bottom:12px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 650px){ .row { grid-template-columns:1fr; } }
    label { display:block; font-size:12px; color:#333; margin-bottom:6px; }
    input, select, textarea {
      width:100%; box-sizing:border-box; padding:12px;
      border-radius:12px; border:1px solid #d7d7d7; background:#fff; font-size:16px;
    }
    textarea { resize: vertical; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn { border:1px solid #d7d7d7; background:#fff; padding:12px 12px; border-radius:12px; font-size:15px; cursor:pointer; }
    .btn.primary { border-color:#111; }
    .pill { display:inline-block; padding:6px 12px; border:1px solid #ddd; border-radius:999px; font-size:13px; background:#fafafa; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted { color:#666; font-size:12px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-top:1px solid #eee; padding:10px 6px; font-size:13px; text-align:left; vertical-align:top; }
    th { font-size:12px; color:#333; }
    .right { text-align:right; }
    .success { background:#e8f5e9; border-color:#b2dfdb; }
    .warn { background:#fff8e1; border-color:#ffe082; }
    .danger { background:#ffebee; border-color:#ef9a9a; }
    .tiny { font-size:11px; }
    details summary { cursor:pointer; }
  </style>

  <!-- IMPORTANT: local supabase library (you must upload supabase.js in the repo root) -->
  <script src="./supabase.js"></script>
</head>

<body>
<header>
  <h1>Ketone + Food Tracker</h1>
  <div class="tabs">
    <button class="tab active" data-tab="metrics">Glucose / Ketones</button>
    <button class="tab" data-tab="food">Food (Carbs + kcal)</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>
</header>

<main>
  <!-- METRICS -->
  <section id="tab-metrics" class="tabpage">
    <div class="card">
      <div class="row">
        <div>
          <label>Date & time</label>
          <input id="m-dt" type="datetime-local" />
        </div>
        <div>
          <label>Context</label>
          <select id="m-context">
            <option>Fasting AM</option>
            <option>Pre-meal</option>
            <option>Post-meal (2h)</option>
            <option>Workout</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Glucose (mmol/L)</label>
          <input id="m-glucose" inputmode="decimal" placeholder="e.g., 6.8" />
        </div>
        <div>
          <label>Ketones (mmol/L)</label>
          <input id="m-ketones" inputmode="decimal" placeholder="e.g., 0.8" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Notes (optional)</label>
          <textarea id="m-notes" rows="2"></textarea>
        </div>
        <div>
          <label>Result</label>
          <div class="pill" id="m-result">Enter values</div>
          <div class="muted tiny" style="margin-top:8px">
            Ratio = glucose (mg/dL) √∑ ketones (mmol/L). Zone: &lt;40 Deep, 40‚Äì80 Moderate, &gt;80 Glucose.
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="m-save">Save reading</button>
        <button class="btn" id="m-fasting">üåÖ Fasting AM quick save</button>
        <button class="btn" id="m-refresh">Refresh</button>
      </div>
      <div class="muted tiny" id="m-sync" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Device ID: <span id="device-id" class="mono"></span></div>
        <div class="right">
          <button class="btn" id="copy-device">Copy Device ID</button>
        </div>
      </div>

      <details style="margin-top:10px">
        <summary class="muted">Restore Device ID (if phone changes or storage wipes)</summary>
        <div class="muted" style="margin-top:10px; line-height:1.4">
          If the app ever looks empty, paste your old Device ID below to reconnect to your existing data.
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Paste old Device ID</label>
            <input id="restore-device-id" class="mono" placeholder="paste old device id here" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn primary" id="restore-device-btn">Restore & Reload</button>
          </div>
        </div>
      </details>

      <div style="overflow:auto; margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Context</th>
              <th class="right">Glucose</th>
              <th class="right">Ketones</th>
              <th class="right">Ratio</th>
              <th>Zone</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="m-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- FOOD -->
  <section id="tab-food" class="tabpage" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <label>Day</label>
          <input id="f-day" type="date" />
        </div>
        <div>
          <label>Totals (selected day)</label>
          <div>
            <span class="pill">Carbs: <span id="f-total-carbs" class="mono">0</span> g</span>
            <span class="pill">kcal: <span id="f-total-kcal" class="mono">0</span></span>
          </div>
        </div>
      </div>
      <div class="muted tiny" id="f-sync" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px; font-size:16px">Quick add (day only or save)</h3>

      <div class="row">
        <div>
          <label>Food name</label>
          <input id="q-name" placeholder="e.g., cheese brand, restaurant item..." />
        </div>
        <div>
          <label>When</label>
          <select id="q-meal">
            <option>Breakfast</option>
            <option>Lunch</option>
            <option>Dinner</option>
            <option>Snack</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Mode</label>
          <select id="q-mode">
            <option value="per100g">Per 100g</option>
            <option value="perUnit">Per unit</option>
          </select>
        </div>
        <div>
          <label id="q-amount-label">Grams eaten</label>
          <input id="q-amount" inputmode="decimal" value="100" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label id="q-carbs-label">Carbs per 100g</label>
          <input id="q-carbs" inputmode="decimal" placeholder="e.g., 1.3" />
        </div>
        <div>
          <label id="q-kcal-label">kcal per 100g</label>
          <input id="q-kcal" inputmode="decimal" placeholder="e.g., 402" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Save to library?</label>
          <select id="q-save">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div>
          <label>Notes (optional)</label>
          <input id="q-notes" />
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="q-add">Add to day</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px; font-size:16px">Add from library</h3>

      <div class="row">
        <div>
          <label>Search</label>
          <input id="lib-search" placeholder="type to search..." />
        </div>
        <div>
          <label>Show</label>
          <select id="lib-show">
            <option value="all" selected>All</option>
            <option value="fav">Favorites ‚≠ê</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Pick</label>
          <select id="lib-pick" size="7" style="height:170px"></select>
        </div>
        <div>
          <label id="lib-amount-label">Amount</label>
          <input id="lib-amount" inputmode="decimal" value="1" />
          <div class="muted tiny" id="lib-hint" style="margin-top:6px"></div>

          <label style="margin-top:10px">When</label>
          <select id="lib-meal">
            <option>Breakfast</option>
            <option>Lunch</option>
            <option>Dinner</option>
            <option>Snack</option>
            <option>Other</option>
          </select>

          <div class="actions">
            <button class="btn primary" id="lib-add">Add</button>
            <button class="btn" id="lib-refresh">Refresh library</button>
          </div>
        </div>
      </div>

      <details style="margin-top:10px">
        <summary class="muted">Manage library (add/update favorites)</summary>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Name</label>
            <input id="lib-name" />
          </div>
          <div>
            <label>Favorite ‚≠ê</label>
            <select id="lib-fav">
              <option value="false" selected>No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Mode</label>
            <select id="lib-mode">
              <option value="per100g">per100g</option>
              <option value="perUnit">perUnit</option>
            </select>
          </div>
          <div>
            <label id="lib-carbs-label2">Carbs per 100g</label>
            <input id="lib-carbs" inputmode="decimal" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label id="lib-kcal-label2">kcal per 100g</label>
            <input id="lib-kcal" inputmode="decimal" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="lib-prefill">Prefill from selected</button>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="lib-save">Save / Update</button>
          <button class="btn" id="lib-delete">Delete</button>
        </div>
      </details>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Items: <span id="f-count">0</span></div>
        <div class="right">
          <button class="btn" id="f-refresh">Refresh day</button>
        </div>
      </div>

      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Meal</th>
              <th>Food</th>
              <th class="right">Amt</th>
              <th class="right">Carbs</th>
              <th class="right">kcal</th>
            </tr>
          </thead>
          <tbody id="f-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" class="tabpage" style="display:none">
    <div class="card">
      <h3 style="margin:0 0 10px; font-size:16px">Settings</h3>

      <div class="row">
        <div>
          <label>Deep cutoff</label>
          <input id="s-deep" inputmode="decimal" value="40">
        </div>
        <div>
          <label>Moderate max</label>
          <input id="s-mod" inputmode="decimal" value="80">
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="s-save">Save settings</button>
        <button class="btn" id="s-export">Export backup (JSON)</button>
        <label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
          Import backup
          <input id="s-import" type="file" accept="application/json" style="display:none">
        </label>
      </div>

      <div class="muted tiny" style="margin-top:10px">
        No-login mode: your app uses a <span class="mono">device_id</span> stored on this device to separate your data.
      </div>
    </div>
  </section>
</main>

<script>
/*** CONFIG (already filled with your keys) ***/
const SUPABASE_URL = "https://fyxmnlnxtpufxrtblvwr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5eG1ubG54dHB1ZnhydGJsdndyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5ODEyMDYsImV4cCI6MjA4MzU1NzIwNn0.NJRsMPMkJbX2TpBbGoXbFuE_u7w9EZJ0XXZ5RFxCgec";

/*** Utilities ***/
const $ = (id) => document.getElementById(id);
const parseNum = (v) => {
  const s = String(v ?? "").trim().replace(",", ".");
  if (!s) return NaN;
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
};
const round = (x, dp=1) => Number.isFinite(x) ? (Math.round(x * (10**dp)) / (10**dp)).toFixed(dp) : "";
const todayISO = () => new Date().toISOString().slice(0,10);
const nowLocalDatetime = () => {
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
};
const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)+String(Date.now()));
const esc = (s) => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

/*** Device ID (no login) ***/
const DEVICE_KEY = "kt_device_id_v3";
let DEVICE_ID = localStorage.getItem(DEVICE_KEY);
if (!DEVICE_ID) { DEVICE_ID = uuid(); localStorage.setItem(DEVICE_KEY, DEVICE_ID); }

/*** Local settings ***/
const SETTINGS_KEY = "kt_settings_v3";
let settings = { deep: 40, mod: 80 };
try { settings = { ...settings, ...(JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}")) }; } catch {}
const saveSettings = () => localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));

/*** Supabase client (IMPORTANT: use sb, not supabase) ***/
if (!window.supabase || !window.supabase.createClient) {
  alert("Supabase library not loaded. Make sure supabase.js is uploaded in the repo root.");
}
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/*** PWA Service Worker ***/
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
}

/*** Tabs ***/
const tabButtons = [...document.querySelectorAll("button.tab")];
const pages = { metrics: $("tab-metrics"), food: $("tab-food"), settings: $("tab-settings") };
function showTab(name){
  Object.entries(pages).forEach(([k,el]) => el.style.display = (k===name ? "" : "none"));
  tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab===name));
}
tabButtons.forEach(b => b.addEventListener("click", () => showTab(b.dataset.tab)));

/*** Zone helpers ***/
function zoneForRatio(r){
  if (!Number.isFinite(r)) return {label:"‚Äî", cls:"", short:"‚Äî"};
  if (r < settings.deep) return {label:`Deep (<${settings.deep})`, cls:"success", short:"Deep"};
  if (r <= settings.mod) return {label:`Moderate (${settings.deep}‚Äì${settings.mod})`, cls:"warn", short:"Moderate"};
  return {label:`Glucose (>${settings.mod})`, cls:"danger", short:"Glucose"};
}

/*** Device ID UI + restore ***/
$("device-id").textContent = DEVICE_ID;

$("copy-device").addEventListener("click", async () => {
  try { await navigator.clipboard.writeText(DEVICE_ID); alert("Device ID copied. Save it in Notes."); }
  catch { alert("Copy failed. Manually copy the Device ID."); }
});

$("restore-device-btn").addEventListener("click", async () => {
  const v = $("restore-device-id").value.trim();
  if (!v) return alert("Paste the old Device ID first.");
  if (!confirm("Restore this Device ID on this device and reload?")) return;
  DEVICE_ID = v;
  localStorage.setItem(DEVICE_KEY, DEVICE_ID);
  $("device-id").textContent = DEVICE_ID;
  $("restore-device-id").value = "";
  await loadMetrics(); await loadLibrary(); await loadFoodDay();
  alert("Restored.");
});

/*** Metrics UI ***/
function metricsPreview(){
  const g = parseNum($("m-glucose").value);
  const k = parseNum($("m-ketones").value);
  const mgdl = Number.isFinite(g) ? g*18 : NaN;
  const ratio = (Number.isFinite(mgdl) && Number.isFinite(k) && k>0) ? mgdl/k : NaN;
  const z = zoneForRatio(ratio);
  const pill = $("m-result");
  pill.className = "pill " + (z.cls||"");
  pill.textContent = Number.isFinite(ratio) ? `Ratio ${round(ratio,1)} ‚Üí ${z.label}` : "Enter values";
}
["m-glucose","m-ketones"].forEach(id => $(id).addEventListener("input", metricsPreview));

async function saveMetric(contextOverride=null){
  const dtLocal = $("m-dt").value || nowLocalDatetime();
  const ts = new Date(dtLocal).toISOString();

  const g = parseNum($("m-glucose").value);
  const k = parseNum($("m-ketones").value);
  if (!Number.isFinite(g) || g<=0) return alert("Enter glucose (mmol/L).");
  if (!Number.isFinite(k) || k<=0) return alert("Enter ketones (mmol/L).");

  const mgdl = g*18;
  const ratio = mgdl/k;
  const z = zoneForRatio(ratio);

  const context = contextOverride ?? $("m-context").value;
  const notes = $("m-notes").value || "";

  $("m-sync").textContent = "Saving...";
  const { error } = await sb.from("metrics_log").insert([{
    device_id: DEVICE_ID, ts, context,
    glucose_mmol: g, ketones_mmol: k,
    glucose_mgdl: mgdl, ratio, zone: z.short, notes
  }]);
  if (error) { $("m-sync").textContent = "Save failed."; return alert(error.message); }

  $("m-sync").textContent = "Saved ‚úì";
  $("m-glucose").value = ""; $("m-ketones").value = ""; $("m-notes").value = "";
  metricsPreview();
  await loadMetrics();
}

$("m-save").addEventListener("click", () => saveMetric());
$("m-fasting").addEventListener("click", () => { $("m-context").value="Fasting AM"; saveMetric("Fasting AM"); });
$("m-refresh").addEventListener("click", () => loadMetrics());

async function loadMetrics(){
  $("m-sync").textContent = "Loading...";
  const { data, error } = await sb.from("metrics_log")
    .select("*").eq("device_id", DEVICE_ID)
    .order("ts", { ascending:false }).limit(100);

  if (error) { $("m-sync").textContent = "Load failed."; return; }

  const tb = $("m-tbody");
  tb.innerHTML = "";
  for (const r of (data||[])) {
    const d = new Date(r.ts);
    const ratio = Number(r.ratio);
    const z = zoneForRatio(ratio);
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${esc(d.toLocaleString())}</td>
        <td>${esc(r.context||"")}</td>
        <td class="right">${esc(round(Number(r.glucose_mmol),1))}</td>
        <td class="right">${esc(round(Number(r.ketones_mmol),2))}</td>
        <td class="right">${esc(round(ratio,1))}</td>
        <td><span class="pill ${z.cls}">${esc(r.zone||"")}</span></td>
        <td>${esc(r.notes||"")}</td>
      </tr>
    `);
  }
  $("m-sync").textContent = "";
}

/*** Food UI ***/
$("f-day").value = todayISO();
$("f-day").addEventListener("change", () => loadFoodDay());
$("f-refresh").addEventListener("click", () => loadFoodDay());
$("lib-refresh").addEventListener("click", () => loadLibrary());

function syncQuickLabels(){
  const mode = $("q-mode").value;
  $("q-amount-label").textContent = (mode==="per100g" ? "Grams eaten" : "Units/servings");
  $("q-carbs-label").textContent = (mode==="per100g" ? "Carbs per 100g" : "Carbs per unit");
  $("q-kcal-label").textContent = (mode==="per100g" ? "kcal per 100g" : "kcal per unit");
  if (mode==="per100g" && $("q-amount").value==="1") $("q-amount").value="100";
  if (mode==="perUnit" && $("q-amount").value==="100") $("q-amount").value="1";
}
$("q-mode").addEventListener("change", syncQuickLabels);
syncQuickLabels();

function totals(mode, carbsBase, kcalBase, amount){
  if (mode==="per100g") return { carbs: (carbsBase/100)*amount, kcal: (kcalBase/100)*amount };
  return { carbs: carbsBase*amount, kcal: kcalBase*amount };
}

async function addQuickFood(){
  const day = $("f-day").value;
  const meal = $("q-meal").value;
  const name = $("q-name").value.trim();
  const mode = $("q-mode").value;
  const amount = parseNum($("q-amount").value);
  const carbsBase = parseNum($("q-carbs").value);
  const kcalBase = parseNum($("q-kcal").value);
  const saveToLib = $("q-save").value === "yes";

  if (!name) return alert("Enter food name.");
  if (!Number.isFinite(amount) || amount<=0) return alert("Enter amount.");
  if (!Number.isFinite(carbsBase) || carbsBase<0) return alert("Enter carbs base.");
  if (!Number.isFinite(kcalBase) || kcalBase<0) return alert("Enter kcal base.");

  const t = totals(mode, carbsBase, kcalBase, amount);

  $("f-sync").textContent = "Saving...";
  const { error } = await sb.from("food_log").insert([{
    device_id: DEVICE_ID, day, meal, name, mode, amount,
    carbs_total: t.carbs, kcal_total: t.kcal
  }]);
  if (error) { $("f-sync").textContent="Save failed."; return alert(error.message); }

  if (saveToLib) {
    const { data: existing } = await sb.from("food_library")
      .select("id").eq("device_id", DEVICE_ID).eq("name", name).limit(1);

    if (existing && existing.length) {
      await sb.from("food_library").update({ mode, carbs_base: carbsBase, kcal_base: kcalBase }).eq("id", existing[0].id);
    } else {
      await sb.from("food_library").insert([{ device_id: DEVICE_ID, name, mode, carbs_base: carbsBase, kcal_base: kcalBase, fav: false }]);
    }
    await loadLibrary();
  }

  $("q-name").value=""; $("q-carbs").value=""; $("q-kcal").value=""; $("q-notes").value=""; $("q-save").value="no";
  $("f-sync").textContent="Saved ‚úì";
  await loadFoodDay();
}
$("q-add").addEventListener("click", addQuickFood);

let libraryCache = [];
function renderLibrary(){
  const q = $("lib-search").value.trim().toLowerCase();
  const show = $("lib-show").value;
  let list = [...libraryCache];
  if (show==="fav") list = list.filter(x => x.fav);
  if (q) list = list.filter(x => (x.name||"").toLowerCase().includes(q));
  list.sort((a,b) => (b.fav?1:0)-(a.fav?1:0) || (a.name||"").localeCompare(b.name||""));

  const pick = $("lib-pick");
  const selected = pick.value;
  pick.innerHTML = list.map(x => {
    const star = x.fav ? "‚≠ê " : "";
    const base = x.mode==="per100g" ? `C:${x.carbs_base}/100g, ${x.kcal_base}/100g` : `C:${x.carbs_base}/unit, ${x.kcal_base}/unit`;
    return `<option value="${x.id}">${star}${esc(x.name)} (${base})</option>`;
  }).join("") || `<option disabled>(no foods)</option>`;

  if ([...pick.options].some(o => o.value===selected)) pick.value = selected;
  syncLibrarySelection();
}
$("lib-search").addEventListener("input", () => { clearTimeout(window.__ls); window.__ls=setTimeout(renderLibrary,120); });
$("lib-show").addEventListener("change", renderLibrary);
$("lib-pick").addEventListener("change", syncLibrarySelection);

function syncLibrarySelection(){
  const id = $("lib-pick").value;
  const f = libraryCache.find(x => String(x.id)===String(id));
  if (!f) { $("lib-hint").textContent=""; return; }
  $("lib-amount-label").textContent = (f.mode==="per100g" ? "Grams eaten" : "Units/servings");
  $("lib-hint").textContent = f.mode==="per100g" ? "Example: enter 32 for 32g." : "Example: enter 2 for 2 servings.";
  $("lib-name").value = f.name || "";
  $("lib-fav").value = String(!!f.fav);
  $("lib-mode").value = f.mode;
  $("lib-carbs").value = f.carbs_base;
  $("lib-kcal").value = f.kcal_base;
  syncManageLabels();
}
function syncManageLabels(){
  const mode = $("lib-mode").value;
  $("lib-carbs-label2").textContent = (mode==="per100g" ? "Carbs per 100g" : "Carbs per unit");
  $("lib-kcal-label2").textContent = (mode==="per100g" ? "kcal per 100g" : "kcal per unit");
}
$("lib-mode").addEventListener("change", syncManageLabels);
syncManageLabels();

$("lib-prefill").addEventListener("click", () => {
  const id = $("lib-pick").value;
  const f = libraryCache.find(x => String(x.id)===String(id));
  if (!f) return alert("Select a library item first.");
  $("lib-name").value=f.name||""; $("lib-fav").value=String(!!f.fav); $("lib-mode").value=f.mode;
  $("lib-carbs").value=f.carbs_base; $("lib-kcal").value=f.kcal_base;
  syncManageLabels();
});

async function loadLibrary(){
  $("f-sync").textContent = "Loading library...";
  const { data, error } = await sb.from("food_library")
    .select("*").eq("device_id", DEVICE_ID).order("name", {ascending:true}).limit(1000);
  if (error) { $("f-sync").textContent="Library load failed."; return; }
  libraryCache = data || [];
  renderLibrary();
  $("f-sync").textContent = "";
}

async function addFromLibrary(){
  const day = $("f-day").value;
  const meal = $("lib-meal").value;
  const id = $("lib-pick").value;
  const f = libraryCache.find(x => String(x.id)===String(id));
  if (!f) return alert("Pick a food.");
  const amount = parseNum($("lib-amount").value);
  if (!Number.isFinite(amount) || amount<=0) return alert("Enter amount.");
  const t = totals(f.mode, Number(f.carbs_base), Number(f.kcal_base), amount);

  $("f-sync").textContent = "Saving...";
  const { error } = await sb.from("food_log").insert([{
    device_id: DEVICE_ID, day, meal,
    name: f.name, mode: f.mode, amount,
    carbs_total: t.carbs, kcal_total: t.kcal
  }]);
  if (error) { $("f-sync").textContent="Save failed."; return alert(error.message); }
  $("f-sync").textContent="Saved ‚úì";
  await loadFoodDay();
}
$("lib-add").addEventListener("click", addFromLibrary);

async function saveLibraryItem(){
  const id = $("lib-pick").value || null;
  const name = $("lib-name").value.trim();
  const fav = $("lib-fav").value === "true";
  const mode = $("lib-mode").value;
  const carbs = parseNum($("lib-carbs").value);
  const kcal  = parseNum($("lib-kcal").value);
  if (!name) return alert("Enter name.");
  if (!Number.isFinite(carbs) || carbs<0) return alert("Enter carbs.");
  if (!Number.isFinite(kcal) || kcal<0) return alert("Enter kcal.");

  $("f-sync").textContent = "Saving library...";
  if (id) {
    const { error } = await sb.from("food_library").update({ name,fav,mode,carbs_base:carbs,kcal_base:kcal }).eq("id", id);
    if (error) { $("f-sync").textContent="Save failed."; return alert(error.message); }
  } else {
    const { error } = await sb.from("food_library").insert([{ device_id: DEVICE_ID, name,fav,mode,carbs_base:carbs,kcal_base:kcal }]);
    if (error) { $("f-sync").textContent="Save failed."; return alert(error.message); }
  }
  $("f-sync").textContent="Saved ‚úì";
  await loadLibrary();
}
$("lib-save").addEventListener("click", saveLibraryItem);

async function deleteLibraryItem(){
  const id = $("lib-pick").value;
  if (!id) return alert("Pick an item to delete.");
  if (!confirm("Delete this food from library?")) return;
  $("f-sync").textContent="Deleting...";
  const { error } = await sb.from("food_library").delete().eq("id", id);
  if (error) { $("f-sync").textContent="Delete failed."; return alert(error.message); }
  $("f-sync").textContent="Deleted ‚úì";
  await loadLibrary();
}
$("lib-delete").addEventListener("click", deleteLibraryItem);

async function loadFoodDay(){
  const day = $("f-day").value;
  $("f-sync").textContent = "Loading day...";
  const { data, error } = await sb.from("food_log")
    .select("*").eq("device_id", DEVICE_ID).eq("day", day)
    .order("id", {ascending:false}).limit(500);
  if (error) { $("f-sync").textContent="Load failed."; return; }

  const rows = data || [];
  $("f-count").textContent = rows.length;

  let carbs = 0, kcal = 0;
  for (const r of rows) { carbs += Number(r.carbs_total||0); kcal += Number(r.kcal_total||0); }
  $("f-total-carbs").textContent = round(carbs,1);
  $("f-total-kcal").textContent = Math.round(kcal);

  const tb = $("f-tbody");
  tb.innerHTML = "";
  for (const r of rows) {
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${esc(r.meal||"")}</td>
        <td>${esc(r.name||"")}</td>
        <td class="right">${esc(round(Number(r.amount), r.mode==="per100g" ? 1 : 2))}${r.mode==="per100g" ? " g" : ""}</td>
        <td class="right">${esc(round(Number(r.carbs_total),2))}</td>
        <td class="right">${esc(Math.round(Number(r.kcal_total)))}</td>
      </tr>
    `);
  }
  $("f-sync").textContent = "";
}

/*** Settings tab ***/
$("s-deep").value = settings.deep;
$("s-mod").value = settings.mod;

$("s-save").addEventListener("click", () => {
  const deep = parseNum($("s-deep").value);
  const mod = parseNum($("s-mod").value);
  if (!Number.isFinite(deep) || !Number.isFinite(mod) || deep<=0 || mod<=deep) {
    return alert("Deep must be >0 and Moderate max must be > Deep.");
  }
  settings.deep = deep; settings.mod = mod; saveSettings();
  metricsPreview();
  alert("Saved.");
});

$("s-export").addEventListener("click", async () => {
  const { data: m } = await sb.from("metrics_log").select("*").eq("device_id", DEVICE_ID);
  const { data: fl } = await sb.from("food_log").select("*").eq("device_id", DEVICE_ID);
  const { data: lib } = await sb.from("food_library").select("*").eq("device_id", DEVICE_ID);
  const blob = new Blob([JSON.stringify({ device_id: DEVICE_ID, settings, metrics: m||[], food_log: fl||[], food_library: lib||[] }, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `ketone-backup-${todayISO()}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

$("s-import").addEventListener("change", async (ev) => {
  const file = ev.target.files?.[0];
  if (!file) return;
  const text = await file.text();
  let obj;
  try { obj = JSON.parse(text); } catch { return alert("Bad JSON."); }
  if (!confirm("Import will ADD rows into your database for the CURRENT Device ID. Continue?")) return;

  if (obj.metrics?.length) {
    const pack = obj.metrics.map(x => ({
      device_id: DEVICE_ID,
      ts: x.ts || x.created_at || new Date().toISOString(),
      context: x.context || "",
      glucose_mmol: Number(x.glucose_mmol),
      ketones_mmol: Number(x.ketones_mmol),
      glucose_mgdl: Number(x.glucose_mgdl),
      ratio: Number(x.ratio),
      zone: x.zone || "‚Äî",
      notes: x.notes || ""
    }));
    await sb.from("metrics_log").insert(pack);
  }
  if (obj.food_library?.length) {
    const pack = obj.food_library.map(x => ({
      device_id: DEVICE_ID,
      name: x.name,
      mode: x.mode,
      carbs_base: Number(x.carbs_base),
      kcal_base: Number(x.kcal_base),
      fav: !!x.fav
    }));
    await sb.from("food_library").insert(pack);
  }
  if (obj.food_log?.length) {
    const pack = obj.food_log.map(x => ({
      device_id: DEVICE_ID,
      day: x.day,
      meal: x.meal || "Other",
      name: x.name,
      mode: x.mode,
      amount: Number(x.amount),
      carbs_total: Number(x.carbs_total),
      kcal_total: Number(x.kcal_total)
    }));
    await sb.from("food_log").insert(pack);
  }

  await loadMetrics(); await loadLibrary(); await loadFoodDay();
  alert("Import done.");
  ev.target.value = "";
});

/*** Init ***/
$("m-dt").value = nowLocalDatetime();
metricsPreview();
loadMetrics();
loadLibrary();
loadFoodDay();
</script>
</body>
</html>
